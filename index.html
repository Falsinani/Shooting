<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>Energy Breaker</title>

<meta name="viewport"
content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<style>
html,body{
  margin:0; padding:0;
  width:100%; height:100%;
  background:#070b1a;
  overflow:hidden;
  touch-action:none;
  overscroll-behavior:none;
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
}
*{
  -webkit-user-select:none;
  user-select:none;
  -webkit-touch-callout:none;
}
canvas{display:block;width:100vw;height:100vh}
#hud{
  position:fixed;top:10px;left:10px;right:10px;
  display:flex;justify-content:space-between;
  color:#fff;font-size:14px;
}
.badge{
  background:rgba(255,255,255,.08);
  padding:8px 12px;
  border-radius:12px;
  backdrop-filter:blur(6px);
}
</style>
</head>

<body>
<div id="hud">
  <div class="badge">ðŸ’¥ Ù…Ø­Ø·Ù‘Ù…Ø©: <b id="broken">0</b></div>
  <div class="badge">ðŸ”« Ø§Ù„Ø³Ù„Ø§Ø­: <b id="weapon">Ø¹Ø§Ø¯ÙŠ</b></div>
</div>
<canvas id="c"></canvas>

<script>
// ================= SAFETY =================
document.addEventListener("gesturestart",e=>e.preventDefault());
document.addEventListener("dblclick",e=>e.preventDefault(),{passive:false});

// ================= CANVAS =================
const c=document.getElementById("c"),ctx=c.getContext("2d");
let W,H,DPR;
function resize(){
  DPR=Math.min(2,devicePixelRatio||1);
  W=innerWidth;H=innerHeight;
  c.width=W*DPR;c.height=H*DPR;
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener("resize",resize);resize();

// ================= AUDIO (FIXED iOS) =================
let audioCtx=null, musicOsc=null;
function startAudio(){
  if(audioCtx) return;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  musicOsc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  musicOsc.type="sine";
  musicOsc.frequency.value=90;
  gain.gain.value=0.03;
  musicOsc.connect(gain).connect(audioCtx.destination);
  musicOsc.start();
}
function sfx(freq,dur=0.05){
  if(!audioCtx) return;
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.frequency.value=freq;
  g.gain.value=0.08;
  o.connect(g).connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime+dur);
}

// ================= HAPTIC =================
function haptic(ms){ if(navigator.vibrate) navigator.vibrate(ms); }

// ================= GAME =================
const player={x:W/2,y:H-90,w:40,h:40};
let dragging=false,lastX=0;
let bullets=[],objects=[],particles=[];
let cooldown=0,energy=1;
let broken=0;
let weapon="normal",weaponTimer=0;

const brokenEl=document.getElementById("broken");
const weaponEl=document.getElementById("weapon");

c.addEventListener("pointerdown",e=>{
  dragging=true;lastX=e.clientX;
  c.setPointerCapture(e.pointerId);
  startAudio();
});
c.addEventListener("pointermove",e=>{
  if(!dragging) return;
  const dx=e.clientX-lastX;
  lastX=e.clientX;
  player.x+=dx*1.4;
  player.x=Math.max(30,Math.min(W-30,player.x));
});
c.addEventListener("pointerup",()=>dragging=false);
c.addEventListener("pointercancel",()=>dragging=false);

function spawn(){
  const isPower=Math.random()<0.25;
  objects.push({
    x:Math.random()*(W-80)+40,
    y:-60,
    r:isPower?18:26,
    type:isPower?"power":"barrier",
    kind:Math.random()<0.5?"laser":"spread"
  });
}

function explode(x,y,color){
  haptic(40); sfx(120,0.1);
  for(let i=0;i<20;i++)
    particles.push({
      x,y,
      vx:(Math.random()-0.5)*400,
      vy:(Math.random()-0.5)*400,
      life:0.6,
      color
    });
}

function shoot(){
  if(cooldown>0||energy<0.08) return;
  sfx(400); haptic(10);
  if(weapon==="laser"){
    bullets.push({x:player.x,y:player.y-30,v:-1200,r:4,laser:true});
  }else if(weapon==="spread"){
    for(let a=-0.4;a<=0.4;a+=0.4)
      bullets.push({x:player.x,y:player.y-30,v:-700,r:5,dx:a});
  }else{
    bullets.push({x:player.x,y:player.y-30,v:-800,r:6});
  }
  cooldown=0.15; energy-=0.08;
}

let spawnT=0,last=performance.now();
function loop(now){
  const dt=Math.min(0.033,(now-last)/1000);last=now;
  ctx.fillStyle="#070b1a";ctx.fillRect(0,0,W,H);

  energy=Math.min(1,energy+dt*0.3);
  cooldown=Math.max(0,cooldown-dt);
  shoot();

  if(weapon!=="normal"){
    weaponTimer-=dt;
    if(weaponTimer<=0){ weapon="normal"; weaponEl.textContent="Ø¹Ø§Ø¯ÙŠ"; }
  }

  spawnT-=dt;
  if(spawnT<=0){ spawn(); spawnT=0.8; }

  bullets.forEach(b=>{
    b.y+=b.v*dt;
    if(b.dx) b.x+=b.dx*400*dt;
  });
  objects.forEach(o=>o.y+=150*dt);

  // collisions
  for(let i=bullets.length-1;i>=0;i--){
    for(let j=objects.length-1;j>=0;j--){
      const b=bullets[i],o=objects[j];
      const d=Math.hypot(b.x-o.x,b.y-o.y);
      if(d<o.r){
        bullets.splice(i,1);
        objects.splice(j,1);
        if(o.type==="barrier"){
          broken++; brokenEl.textContent=broken;
          explode(o.x,o.y,"#7fffb2");
        }else{
          weapon=o.kind;
          weaponTimer=6;
          weaponEl.textContent=o.kind==="laser"?"Ù„ÙŠØ²Ø±":"Ù…ØªÙ†Ø§Ø«Ø±";
          explode(o.x,o.y,"#ffd27d");
        }
        break;
      }
    }
  }

  particles.forEach(p=>{
    p.life-=dt;
    p.x+=p.vx*dt;
    p.y+=p.vy*dt;
  });

  bullets=bullets.filter(b=>b.y>-50);
  particles=particles.filter(p=>p.life>0);

  // DRAW
  ctx.fillStyle="#7fffb2";
  ctx.beginPath();
  ctx.moveTo(player.x,player.y-20);
  ctx.lineTo(player.x+20,player.y+20);
  ctx.lineTo(player.x-20,player.y+20);
  ctx.fill();

  bullets.forEach(b=>{
    ctx.strokeStyle=b.laser?"#ff3":"#ffd27d";
    ctx.lineWidth=b.laser?3:1;
    ctx.beginPath();
    ctx.moveTo(b.x,b.y);
    ctx.lineTo(b.x,b.y+15);
    ctx.stroke();
  });

  objects.forEach(o=>{
    const g=ctx.createRadialGradient(o.x,o.y,5,o.x,o.y,o.r);
    g.addColorStop(0,o.type==="power"?"#fff":"#7fffb2");
    g.addColorStop(1,"transparent");
    ctx.fillStyle=g;
    ctx.beginPath();
    ctx.arc(o.x,o.y,o.r,0,Math.PI*2);
    ctx.fill();
  });

  particles.forEach(p=>{
    ctx.globalAlpha=p.life;
    ctx.fillStyle=p.color;
    ctx.fillRect(p.x,p.y,4,4);
  });
  ctx.globalAlpha=1;

  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);
</script>
</body>
</html>
