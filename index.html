<!doctype html>
<html lang="ar">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Space Shuttle Blaster</title>
<style>
html,body{
  margin:0;padding:0;background:#05070b;overflow:hidden;
  touch-action:none;font-family:system-ui,-apple-system,Segoe UI
}
canvas{display:block}

/* ===== HUD ===== */
#hud{
  position:fixed;top:0;left:0;right:0;
  display:flex;justify-content:space-between;align-items:center;
  padding:10px 14px;
  pointer-events:none;
  color:#eaf2ff;font-size:13px;
}
.hud-box{
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.15);
  border-radius:14px;
  padding:6px 10px;
  backdrop-filter:blur(6px);
}
</style>
</head>
<body>

<canvas id="c"></canvas>

<div id="hud">
  <div class="hud-box">ðŸ’¥ <span id="score">0</span></div>
  <div class="hud-box">ðŸ”« <span id="weapon">NORMAL</span></div>
  <div class="hud-box">âš¡ <span id="timer">0</span>s</div>
</div>

<script>
/* ================= SETUP ================= */
const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");
let W,H,DPR;
function resize(){
  DPR=Math.min(2,devicePixelRatio||1);
  W=innerWidth;H=innerHeight;
  canvas.width=W*DPR;canvas.height=H*DPR;
  canvas.style.width=W+"px";canvas.style.height=H+"px";
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
resize();addEventListener("resize",resize);

const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const rand=(a,b)=>a+Math.random()*(b-a);

/* ================= AUDIO (100% iOS SAFE) ================= */
let audioCtx=null, audioUnlocked=false;

function unlockAudio(){
  if(audioUnlocked) return;
  audioCtx=new (window.AudioContext||webkitAudioContext)();
  const buffer=audioCtx.createBuffer(1,1,audioCtx.sampleRate);
  const src=audioCtx.createBufferSource();
  src.buffer=buffer;
  src.connect(audioCtx.destination);
  src.start(0);
  audioUnlocked=true;
}

function sfxShoot(){
  if(!audioUnlocked) return;
  const t=audioCtx.currentTime;
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.type="sawtooth";
  o.frequency.setValueAtTime(180,t);
  g.gain.setValueAtTime(0.07,t);
  g.gain.exponentialRampToValueAtTime(0.0001,t+0.12);
  o.connect(g);g.connect(audioCtx.destination);
  o.start(t);o.stop(t+0.14);
}

function sfxBoom(){
  if(!audioUnlocked) return;
  const t=audioCtx.currentTime;
  const b=audioCtx.createBuffer(1,audioCtx.sampleRate*0.3,audioCtx.sampleRate);
  const d=b.getChannelData(0);
  for(let i=0;i<d.length;i++)d[i]=(Math.random()*2-1)*(1-i/d.length);
  const n=audioCtx.createBufferSource();
  const g=audioCtx.createGain();
  n.buffer=b;
  g.gain.setValueAtTime(0.35,t);
  g.gain.exponentialRampToValueAtTime(0.0001,t+0.3);
  n.connect(g);g.connect(audioCtx.destination);
  n.start(t);
}

/* ================= PLAYER ================= */
const player={x:0,y:0,targetX:0,tilt:0};

/* ================= GAME STATE ================= */
let score=0;
const scoreEl=document.getElementById("score");
const weaponEl=document.getElementById("weapon");
const timerEl=document.getElementById("timer");

/* ================= WEAPONS ================= */
let weapon="NORMAL";
let weaponTimer=0;

/* ================= ENTITIES ================= */
const rockets=[];
const asteroids=[];
const drops=[];

/* ================= INPUT ================= */
canvas.addEventListener("pointerdown",e=>{
  unlockAudio();
  player.targetX=e.clientX;
});
canvas.addEventListener("pointermove",e=>{
  player.targetX=e.clientX;
});

/* ================= DRAW ================= */
function drawBackground(){
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,"#070d1d");
  g.addColorStop(1,"#02040a");
  ctx.fillStyle=g;
  ctx.fillRect(0,0,W,H);
}

function drawShuttle(){
  ctx.save();
  ctx.translate(player.x,player.y);
  ctx.rotate(player.tilt);
  ctx.fillStyle="#e5edf5";
  ctx.beginPath();
  ctx.moveTo(0,-22);
  ctx.lineTo(10,18);
  ctx.lineTo(0,14);
  ctx.lineTo(-10,18);
  ctx.closePath();
  ctx.fill();
  ctx.fillStyle="rgba(255,170,90,0.6)";
  ctx.beginPath();
  ctx.moveTo(-4,18);
  ctx.lineTo(0,30+Math.random()*4);
  ctx.lineTo(4,18);
  ctx.fill();
  ctx.restore();
}

function drawRocket(r){
  ctx.save();
  ctx.translate(r.x,r.y);
  ctx.fillStyle=r.type==="LASER"?"#6ff":"#fff";
  ctx.fillRect(-2,-8,4,12);
  ctx.restore();
}

function drawAsteroid(a){
  ctx.save();
  ctx.translate(a.x,a.y);
  ctx.rotate(a.rot);
  ctx.fillStyle="#6c6863";
  ctx.beginPath();
  a.shape.forEach((p,i)=>i?ctx.lineTo(p.x,p.y):ctx.moveTo(p.x,p.y));
  ctx.closePath();ctx.fill();
  ctx.restore();
}

function drawStation(d){
  ctx.save();
  ctx.translate(d.x,d.y);
  ctx.rotate(d.rot);
  ctx.fillStyle="#cfd6df";
  ctx.beginPath();
  ctx.arc(0,0,10,0,Math.PI*2);ctx.fill();
  ctx.fillRect(-22,-4,12,8);
  ctx.fillRect(10,-4,12,8);
  ctx.restore();
}

/* ================= LOGIC ================= */
function spawnAsteroid(){
  const pts=[];
  const r=rand(18,32);
  const n=rand(6,9);
  for(let i=0;i<n;i++){
    const a=i/n*Math.PI*2;
    pts.push({x:Math.cos(a)*r*rand(0.6,1),y:Math.sin(a)*r*rand(0.6,1)});
  }
  asteroids.push({x:rand(40,W-40),y:-40,vy:rand(90,150),rot:rand(-1,1),shape:pts});
}

let shootTimer=0,spawnTimer=0;

/* ================= LOOP ================= */
let last=performance.now();
function loop(t){
  const dt=(t-last)/1000;last=t;
  drawBackground();

  player.x+=(player.targetX-player.x)*8*dt;
  player.x=clamp(player.x,30,W-30);
  player.tilt=(player.targetX-player.x)*0.002;
  drawShuttle();

  if(weaponTimer>0){
    weaponTimer-=dt;
    timerEl.textContent=Math.ceil(weaponTimer);
    if(weaponTimer<=0){
      weapon="NORMAL";
      weaponEl.textContent="NORMAL";
      timerEl.textContent="0";
    }
  }

  shootTimer-=dt;
  if(shootTimer<=0){
    shootTimer=0.18;
    if(weapon==="LASER"){
      rockets.push({x:player.x,y:player.y-24,vy:-700,type:"LASER"});
    }else{
      rockets.push({x:player.x,y:player.y-24,vy:-500,type:"NORMAL"});
    }
    sfxShoot();
    navigator.vibrate?.(5);
  }

  for(let i=rockets.length-1;i>=0;i--){
    const r=rockets[i];
    r.y+=r.vy*dt;
    drawRocket(r);
    if(r.y<-20)rockets.splice(i,1);
  }

  spawnTimer-=dt;
  if(spawnTimer<=0){spawnTimer=rand(0.5,0.8);spawnAsteroid();}

  for(let i=asteroids.length-1;i>=0;i--){
    const a=asteroids[i];
    a.y+=a.vy*dt;a.rot+=0.3*dt;
    drawAsteroid(a);
    for(let j=rockets.length-1;j>=0;j--){
      if(Math.hypot(a.x-rockets[j].x,a.y-rockets[j].y)<28){
        rockets.splice(j,1);
        asteroids.splice(i,1);
        score++;
        scoreEl.textContent=score;
        sfxBoom();
        navigator.vibrate?.(25);
        if(Math.random()<0.35){
          drops.push({x:a.x,y:a.y,vy:80,rot:0});
        }
        break;
      }
    }
  }

  for(let i=drops.length-1;i>=0;i--){
    const d=drops[i];
    d.y+=d.vy*dt;d.rot+=0.6*dt;
    drawStation(d);
    if(Math.hypot(d.x-player.x,d.y-player.y)<24){
      weapon="LASER";
      weaponTimer=8;
      weaponEl.textContent="LASER";
      drops.splice(i,1);
    }
    if(d.y>H+40)drops.splice(i,1);
  }

  requestAnimationFrame(loop);
}

player.x=W/2;player.y=H-80;player.targetX=player.x;
requestAnimationFrame(loop);
</script>
</body>
</html>
